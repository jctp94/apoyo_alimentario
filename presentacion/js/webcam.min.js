var Webcam={version:"1.0.0",protocol:location.protocol.match(/https/i)?"https":"http",swfURL:"",loaded:false,live:false,userMedia:true,params:{width:0,height:0,dest_width:0,dest_height:0,image_format:"jpeg",jpeg_quality:90,force_flash:false},hooks:{load:null,live:null,uploadcomplete:null,uploadprogress:null,error:function(e){alert("Webcam.js Error: "+e)}},cameraIDs:[],cameraID:0,init:function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL;this.userMedia=this.userMedia&&!!navigator.getUserMedia&&!!window.URL;if(navigator.userAgent.match(/Firefox\D+(\d+)/)){if(parseInt(RegExp.$1,10)<21)this.userMedia=null}try{MediaStreamTrack.getSources(function(e){for(var t=0;t!=e.length;t++){var n=e[t];if(n.kind==="video"){Webcam.cameraIDs.push(n.id)}}})}catch(e){}},attach:function(e){if(typeof e=="string"){e=document.getElementById(e)||document.querySelector(e)}if(!e){return this.dispatch("error","Could not locate DOM element to attach to.")}this.container=e;e.innerHTML="";var t=document.createElement("div");e.appendChild(t);this.peg=t;if(!this.params.width)this.params.width=e.offsetWidth;if(!this.params.height)this.params.height=e.offsetHeight;if(!this.params.dest_width)this.params.dest_width=this.params.width;if(!this.params.dest_height)this.params.dest_height=this.params.height;if(this.params.force_flash)this.userMedia=null;var n=this.params.width/this.params.dest_width;var r=this.params.height/this.params.dest_height;if(this.userMedia){var i=document.createElement("video");i.setAttribute("autoplay","autoplay");i.style.width=""+this.params.dest_width+"px";i.style.height=""+this.params.dest_height+"px";if(n!=1||r!=1){e.style.overflow="hidden";i.style.webkitTransformOrigin="0px 0px";i.style.mozTransformOrigin="0px 0px";i.style.msTransformOrigin="0px 0px";i.style.oTransformOrigin="0px 0px";i.style.transformOrigin="0px 0px";i.style.webkitTransform="scaleX("+n+") scaleY("+r+")";i.style.mozTransform="scaleX("+n+") scaleY("+r+")";i.style.msTransform="scaleX("+n+") scaleY("+r+")";i.style.oTransform="scaleX("+n+") scaleY("+r+")";i.style.transform="scaleX("+n+") scaleY("+r+")"}e.appendChild(i);this.video=i;var s={video:true,audio:false};if(Webcam.cameraIDs.length>0){s={video:{optional:[{sourceId:Webcam.cameraIDs[Webcam.cameraID]}]},audio:false}}var o=this;navigator.getUserMedia(s,function(e){i.src=window.URL.createObjectURL(e)||e;Webcam.stream=e;Webcam.loaded=true;Webcam.live=true;Webcam.dispatch("load");Webcam.dispatch("live")},function(e){return o.dispatch("error","Could not access webcam.")})}else{var u=document.createElement("div");u.innerHTML=this.getSWFHTML();e.appendChild(u)}if(this.params.crop_width&&this.params.crop_height){var a=Math.floor(this.params.crop_width*n);var f=Math.floor(this.params.crop_height*r);e.style.width=""+a+"px";e.style.height=""+f+"px";e.style.overflow="hidden";e.scrollLeft=Math.floor(this.params.width/2-a/2);e.scrollTop=Math.floor(this.params.height/2-f/2)}else{e.style.width=""+this.params.width+"px";e.style.height=""+this.params.height+"px"}},reset:function(){if(this.userMedia){try{this.stream.stop()}catch(e){}delete this.stream;delete this.video}this.container.innerHTML="";delete this.container;this.loaded=false;this.live=false},set:function(){if(arguments.length==1){for(var e in arguments[0]){this.params[e]=arguments[0][e]}}else{this.params[arguments[0]]=arguments[1]}},on:function(e,t){e=e.replace(/^on/i,"").toLowerCase();if(typeof this.hooks[e]=="undefined")throw"Event type not supported: "+e;this.hooks[e]=t},dispatch:function(){var e=arguments[0].replace(/^on/i,"").toLowerCase();var t=Array.prototype.slice.call(arguments,1);if(this.hooks[e]){if(typeof this.hooks[e]=="function"){this.hooks[e].apply(this,t)}else if(typeof this.hooks[e]=="array"){this.hooks[e][0][this.hooks[e][1]].apply(this.hooks[e][0],t)}else if(window[this.hooks[e]]){window[this.hooks[e]].apply(window,t)}return true}return false},setSWFLocation:function(e){this.swfURL=e},getSWFHTML:function(){var e="";if(location.protocol.match(/file/)){return'<h1 style="color:red">Sorry, the Webcam.js Flash fallback does not work from local disk.  Please upload it to a web server first.</h1>'}if(!this.swfURL){var t="";var n=document.getElementsByTagName("script");for(var r=0,i=n.length;r<i;r++){var s=n[r].getAttribute("src");if(s&&s.match(/\/webcam(\.min)?\.js/)){t=s.replace(/\/webcam(\.min)?\.js.*$/,"");r=i}}if(t)this.swfURL=t+"/webcam.swf";else this.swfURL="webcam.swf"}if(window.localStorage&&!localStorage.getItem("visited")){this.params.new_user=1;localStorage.setItem("visited",1)}var o="";for(var u in this.params){if(o)o+="&";o+=u+"="+escape(this.params[u])}e+='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" type="application/x-shockwave-flash" codebase="'+this.protocol+'://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="'+this.params.width+'" height="'+this.params.height+'" id="webcam_movie_obj" align="middle"><param name="wmode" value="opaque" /><param name="allowScriptAccess" value="always" /><param name="allowFullScreen" value="false" /><param name="movie" value="'+this.swfURL+'" /><param name="loop" value="false" /><param name="menu" value="false" /><param name="quality" value="best" /><param name="bgcolor" value="#ffffff" /><param name="flashvars" value="'+o+'"/><embed id="webcam_movie_embed" src="'+this.swfURL+'" wmode="opaque" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="'+this.params.width+'" height="'+this.params.height+'" name="webcam_movie_embed" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="'+o+'"></embed></object>';return e},getMovie:function(){if(!this.loaded)return this.dispatch("error","Flash Movie is not loaded yet");var e=document.getElementById("webcam_movie_obj");if(!e||!e._snap)e=document.getElementById("webcam_movie_embed");if(!e)this.dispatch("error","Cannot locate Flash movie in DOM");return e},freeze:function(){var e=this;var t=this.params;if(this.preview_active)this.unfreeze();var n=this.params.width/this.params.dest_width;var r=this.params.height/this.params.dest_height;var i=t.crop_width||t.dest_width;var s=t.crop_height||t.dest_height;var o=document.createElement("canvas");o.width=i;o.height=s;var u=o.getContext("2d");this.preview_canvas=o;this.preview_context=u;if(n!=1||r!=1){o.style.webkitTransformOrigin="0px 0px";o.style.mozTransformOrigin="0px 0px";o.style.msTransformOrigin="0px 0px";o.style.oTransformOrigin="0px 0px";o.style.transformOrigin="0px 0px";o.style.webkitTransform="scaleX("+n+") scaleY("+r+")";o.style.mozTransform="scaleX("+n+") scaleY("+r+")";o.style.msTransform="scaleX("+n+") scaleY("+r+")";o.style.oTransform="scaleX("+n+") scaleY("+r+")";o.style.transform="scaleX("+n+") scaleY("+r+")"}this.snap(function(){o.style.position="relative";o.style.left=""+e.container.scrollLeft+"px";o.style.top=""+e.container.scrollTop+"px";e.container.insertBefore(o,e.peg);e.container.style.overflow="hidden";e.preview_active=true},o)},unfreeze:function(){if(this.preview_active){this.container.removeChild(this.preview_canvas);delete this.preview_context;delete this.preview_canvas;this.preview_active=false}},savePreview:function(e,t){var n=this.params;var r=this.preview_canvas;var i=this.preview_context;if(t){var s=t.getContext("2d");s.drawImage(r,0,0)}e(t?null:r.toDataURL("image/"+n.image_format,n.jpeg_quality/100),r,i);this.unfreeze()},snap:function(e,t){var n=this;var r=this.params;if(!this.loaded)return this.dispatch("error","Webcam is not loaded yet");if(!this.live)return this.dispatch("error","Webcam is not live yet");if(!e)return this.dispatch("error","Please provide a callback function or canvas to snap()");if(this.preview_active){this.savePreview(e,t);return null}var i=document.createElement("canvas");i.width=this.params.dest_width;i.height=this.params.dest_height;var s=i.getContext("2d");var o=function(){if(this.src&&this.width&&this.height){s.drawImage(this,0,0,r.dest_width,r.dest_height)}if(r.crop_width&&r.crop_height){var n=document.createElement("canvas");n.width=r.crop_width;n.height=r.crop_height;var o=n.getContext("2d");o.drawImage(i,Math.floor(r.dest_width/2-r.crop_width/2),Math.floor(r.dest_height/2-r.crop_height/2),r.crop_width,r.crop_height,0,0,r.crop_width,r.crop_height);s=o;i=n}if(t){var u=t.getContext("2d");u.drawImage(i,0,0)}e(t?null:i.toDataURL("image/"+r.image_format,r.jpeg_quality/100),i,s)};if(this.userMedia){s.drawImage(this.video,0,0,this.params.dest_width,this.params.dest_height);o()}else{var u=this.getMovie()._snap();var a=new Image;a.onload=o;a.src="data:image/"+this.params.image_format+";base64,"+u}return null},configure:function(e){if(!e)e="camera";this.getMovie()._configure(e)},flashNotify:function(e,t){switch(e){case"flashLoadComplete":this.loaded=true;this.dispatch("load");break;case"cameraLive":this.live=true;this.dispatch("live");break;case"error":this.dispatch("error",t);break;default:break}},b64ToUint6:function(e){return e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:e===43?62:e===47?63:0},base64DecToArr:function(e,t){var n=e.replace(/[^A-Za-z0-9\+\/]/g,""),r=n.length,i=t?Math.ceil((r*3+1>>2)/t)*t:r*3+1>>2,s=new Uint8Array(i);for(var o,u,a=0,f=0,l=0;l<r;l++){u=l&3;a|=this.b64ToUint6(n.charCodeAt(l))<<18-6*u;if(u===3||r-l===1){for(o=0;o<3&&f<i;o++,f++){s[f]=a>>>(16>>>o&24)&255}a=0}}return s},upload:function(e,t,n){if(n)Webcam.on("uploadComplete",n);var r="webcam";var i="";if(e.match(/^data\:image\/(\w+)/))i=RegExp.$1;else throw"Cannot locate image format in Data URI";var s=e.replace(/^data\:image\/\w+\;base64\,/,"");var o=new XMLHttpRequest;o.open("POST",t,true);if(o.upload&&o.upload.addEventListener){o.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=e.loaded/e.total;Webcam.dispatch("uploadProgress",t,e)}},false)}o.onload=function(){Webcam.dispatch("uploadComplete",o.status,o.responseText,o.statusText)};var u=new Blob([this.base64DecToArr(s)],{type:"image/"+i});var a=new FormData;a.append(r,u,r+"."+i.replace(/e/,""));o.send(a)}};Webcam.init()